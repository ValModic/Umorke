<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <title>Detektivska Mreza</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #ffffff;
      text-align: center;
    }

    table {
      border-collapse: collapse;
      margin: 0 auto;
    }

    th,
    td {
      width: 40px;
      height: 40px;
      text-align: center;
      border: 1px solid #999;
      font-size: 16px;
      cursor: pointer;
      background-color: white;
      user-select: none;
      transition: box-shadow 0.2s, border 0.2s;
    }

    th {
      background-color: #eee;
      font-weight: bold;
      cursor: default;
    }

    .blank {
      background-color: #eee;
      pointer-events: none;
      border: none;
    }

    .controls {
      margin-top: 20px;
    }

    .mark-button {
      margin: 5px;
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 6px;
    }

    .mark-button.selected {
      border-color: #007bff;
      background-color: #e6f0ff;
    }

    .selected {
      box-shadow: 0 0 0 3px #007bff inset;
    }

    .error {
      border: 2px solid red !important;
    }

    /* Novo: vnosna polja */
    .inputs {
      margin-top: 20px;
    }

    .inputs input {
      margin: 5px;
      padding: 8px;
      font-size: 16px;
      width: 160px;
    }
      .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #333;
    color: #fff;
    padding: 12px 20px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    pointer-events: none;
    z-index: 1000;
    font-size: 14px;
  }

  .toast.show {
    opacity: 0.9;
  }
  </style>
</head>
<body>
  <h1>üîç Detektivska Mre≈æa 12√ó12</h1>

  <div class="controls">
    <button class="mark-button" id="btn-check" onclick="setMark('‚úì', this)">‚úì</button>
    <button class="mark-button" id="btn-cross" onclick="setMark('‚úó', this)">‚úó</button>
    <button class="mark-button" id="btn-erase" onclick="setMark('', this)">üßΩ</button>
    <button class="mark-button" onclick="clearBlock()">üßº Poƒçisti 4√ó4 blok</button>
    <button class="mark-button" onclick="resetGrid()">üîÅ Resetiraj mre≈æo</button>
  </div>

  <table id="detectiveGrid"></table>

  <!-- Premaknjeno: 4 vnosna polja pod tabelo -->
  <div class="inputs">
    <input type="text" id="whoInput" placeholder="Kdo?" />
    <input type="text" id="whereInput" placeholder="Kje?" />
    <input type="text" id="weaponInput" placeholder="S ƒçim?" />
    <input type="text" id="whyInput" placeholder="Zakaj?" />
  </div>

  <!-- Upravljanje primerov -->
  <div style="margin-top: 20px; text-align: center;">
    <input type="text" id="caseNameInput" placeholder="Ime primera" style="width: 200px; padding: 8px; font-size: 16px;" />
    <button onclick="saveCase()" style="padding: 8px 16px; font-size: 16px; margin-left: 10px;">üíæ Shrani primer</button>
    <button onclick="newCase()" style="padding: 8px 16px; font-size: 16px; margin-left: 10px; background-color: #28a745; color: white; border: none;">üÜï Nov primer</button>
    <br /><br />
    <select id="casesSelect" style="width: 220px; padding: 8px; font-size: 16px;">
      <option value="" disabled selected>Izberi primer</option>
    </select>
    <button onclick="loadCase()" style="padding: 8px 16px; font-size: 16px; margin-left: 10px;">üìÇ Nalo≈æi</button>
    <button onclick="deleteCase()" style="padding: 8px 16px; font-size: 16px; margin-left: 10px; background-color: #ff4d4d; color: white; border: none;">üóëÔ∏è Izbri≈°i</button>
  </div>

  <script>
    let currentMark = "";
    let lastSelectedCell = null;
    let lastButton = null;
    let selectedCellCoords = null;
    const cellWarnings = new WeakMap();

    function setMark(mark, button) {
      currentMark = mark;
      if (lastButton) lastButton.classList.remove("selected");
      button.classList.add("selected");
      lastButton = button;
    }

    const columnLabels = ["", "S1", "S2", "S3", "S4", "M1", "M2", "M3", "M4", "C1", "C2", "C3", "C4"];
    const rowLabels = ["", "W1", "W2", "W3", "W4", "C1", "C2", "C3", "C4", "M1", "M2", "M3", "M4"];
    const blankCells = new Set();

    blankCells.add("-1,-1");

    for (let i = 4; i < 8; i++) {
      for (let j = 8; j < 12; j++) {
        blankCells.add(`${i},${j}`);
      }
    }
    for (let i = 8; i < 12; i++) {
      for (let j = 4; j < 8; j++) {
        blankCells.add(`${i},${j}`);
      }
    }
    for (let i = 8; i < 12; i++) {
      for (let j = 8; j < 12; j++) {
        blankCells.add(`${i},${j}`);
      }
    }

    const table = document.getElementById("detectiveGrid");
    const cells = [];

    function saveState() {
      const state = cells.map(row =>
        row.map(cell => (cell ? cell.textContent : null))
      );
      localStorage.setItem("detectiveGridState", JSON.stringify(state));
    }

    function loadState() {
      const savedState = localStorage.getItem("detectiveGridState");
      if (!savedState) return;
      const state = JSON.parse(savedState);
      for (let r = 0; r < state.length; r++) {
        for (let c = 0; c < state[r].length; c++) {
          if (cells[r][c] && !cells[r][c].classList.contains("blank")) {
            cells[r][c].textContent = state[r][c];
          }
        }
      }
    }

    function saveInputs() {
      localStorage.setItem("whoInput", document.getElementById("whoInput").value);
      localStorage.setItem("whereInput", document.getElementById("whereInput").value);
      localStorage.setItem("weaponInput", document.getElementById("weaponInput").value);
      localStorage.setItem("whyInput", document.getElementById("whyInput").value);
    }

    function loadInputs() {
      document.getElementById("whoInput").value = localStorage.getItem("whoInput") || "";
      document.getElementById("whereInput").value = localStorage.getItem("whereInput") || "";
      document.getElementById("weaponInput").value = localStorage.getItem("weaponInput") || "";
      document.getElementById("whyInput").value = localStorage.getItem("whyInput") || "";
    }

    function attachInputListeners() {
      ["whoInput", "whereInput", "weaponInput", "whyInput"].forEach(id => {
        document.getElementById(id).addEventListener("input", saveInputs);
      });
    }

    function createCell(r, c) {
      const key = `${r},${c}`;
      const cell = document.createElement("td");

      if (blankCells.has(key)) {
        cell.classList.add("blank");
        return cell;
      }

      const style = [];
      if (r % 4 === 0) style.push("border-top: 2px solid black;");
      if ((r + 1) % 4 === 0) style.push("border-bottom: 2px solid black;");
      if (c % 4 === 0) style.push("border-left: 2px solid black;");
      if ((c + 1) % 4 === 0) style.push("border-right: 2px solid black;");
      cell.setAttribute("style", style.join(" "));

      cell.addEventListener("click", () => {
        if (lastSelectedCell) {
          lastSelectedCell.classList.remove("selected");
          lastSelectedCell.classList.remove("error");
          cellWarnings.set(lastSelectedCell, 0);
        }

        cell.classList.add("selected");
        lastSelectedCell = cell;
        selectedCellCoords = [r, c];

        if (currentMark === "‚úì") {
          const blockRowStart = Math.floor(r / 4) * 4;
          const blockColStart = Math.floor(c / 4) * 4;

          let rowConflict = false;
          for (let col = blockColStart; col < blockColStart + 4; col++) {
            if (col !== c && cells[r][col].textContent === "‚úì") {
              rowConflict = true;
              break;
            }
          }

          let colConflict = false;
          for (let row = blockRowStart; row < blockRowStart + 4; row++) {
            if (row !== r && cells[row][c].textContent === "‚úì") {
              colConflict = true;
              break;
            }
          }

          if (!cellWarnings.has(cell)) cellWarnings.set(cell, 0);

          if (rowConflict || colConflict) {
            let warnCount = cellWarnings.get(cell);
            if (warnCount === 0) {
              cellWarnings.set(cell, 1);
              cell.classList.add("error");
              return;
            } else {
              cellWarnings.set(cell, 0);
              cell.classList.remove("error");
            }
          }
        }

        if (currentMark === "") {
          if (cell.textContent === "‚úì") {
            const blockRowStart = Math.floor(r / 4) * 4;
            const blockColStart = Math.floor(c / 4) * 4;
            for (let i = blockRowStart; i < blockRowStart + 4; i++) {
              if (!cells[i][c].classList.contains("blank")) {
                cells[i][c].textContent = "";
                cells[i][c].classList.remove("error");
                cellWarnings.set(cells[i][c], 0);
              }
            }
            for (let j = blockColStart; j < blockColStart + 4; j++) {
              if (!cells[r][j].classList.contains("blank")) {
                cells[r][j].textContent = "";
                cells[r][j].classList.remove("error");
                cellWarnings.set(cells[r][j], 0);
              }
            }
          }
        } else {
          cell.textContent = currentMark;

          if (currentMark === "‚úì") {
            const blockRow = Math.floor(r / 4) * 4;
            const blockCol = Math.floor(c / 4) * 4;

            for (let i = blockRow; i < blockRow + 4; i++) {
              if (i !== r) {
                const blockCell = cells[i][c];
                if (
                  blockCell &&
                  !blockCell.classList.contains("blank") &&
                  blockCell.textContent !== "‚úì"
                ) {
                  blockCell.textContent = "‚úó";
                }
              }
            }

            for (let j = blockCol; j < blockCol + 4; j++) {
              if (j !== c) {
                const blockCell = cells[r][j];
                if (
                  blockCell &&
                  !blockCell.classList.contains("blank") &&
                  blockCell.textContent !== "‚úì"
                ) {
                  blockCell.textContent = "‚úó";
                }
              }
            }
          }
        }

        saveState();
      });

      return cell;
    }

    const headerRow = document.createElement("tr");
    columnLabels.forEach((label, i) => {
      const th = document.createElement("th");
      if (i === 0) th.classList.add("blank");
      th.textContent = label;
      headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    for (let r = 0; r < 12; r++) {
      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.textContent = rowLabels[r + 1];
      tr.appendChild(th);

      const row = [];
      for (let c = 0; c < 12; c++) {
        const cell = createCell(r, c);
        row.push(cell);
        tr.appendChild(cell);
      }
      cells.push(row);
      table.appendChild(tr);
    }

    // Nalo≈æi podatke ob zagonu
    loadState();
    loadInputs();
    attachInputListeners();

    function clearBlock() {
      if (!selectedCellCoords) return;
      const [r, c] = selectedCellCoords;
      const blockRow = Math.floor(r / 4) * 4;
      const blockCol = Math.floor(c / 4) * 4;
      for (let i = blockRow; i < blockRow + 4; i++) {
        for (let j = blockCol; j < blockCol + 4; j++) {
          const cell = cells[i][j];
          if (cell && !cell.classList.contains("blank")) {
            cell.textContent = "";
            cell.classList.remove("error");
            cellWarnings.set(cell, 0);
          }
        }
      }
      saveState();
    }

    function resetGrid() {
      for (let r = 0; r < 12; r++) {
        for (let c = 0; c < 12; c++) {
          const cell = cells[r][c];
          if (cell && !cell.classList.contains("blank")) {
            cell.textContent = "";
            cell.classList.remove("error");
            cellWarnings.set(cell, 0);
          }
        }
      }
      saveState();
    }

    // Upravljanje primerov ---------------------------------------

    function saveCase() {
      const name = document.getElementById('caseNameInput').value.trim();
      if (!name) {
        alert('Prosim vnesi ime primera!');
        return;
      }

      const state = cells.map(row => row.map(cell => (cell ? cell.textContent : null)));
      const inputs = {
        who: document.getElementById('whoInput').value,
        where: document.getElementById('whereInput').value,
        weapon: document.getElementById('weaponInput').value,
        why: document.getElementById('whyInput').value,
      };

      const caseData = { state, inputs };

      let cases = JSON.parse(localStorage.getItem('detectiveCases') || '{}');
      cases[name] = caseData;
      localStorage.setItem('detectiveCases', JSON.stringify(cases));

      showToast(`‚úî Primer "${name}" shranjen`);
      updateCasesSelect();
    }

    function loadCase() {
      const select = document.getElementById('casesSelect');
      const name = select.value;
      if (!name) {
        alert('Prosim izberi primer za nalaganje!');
        return;
      }

      const cases = JSON.parse(localStorage.getItem('detectiveCases') || '{}');
      const caseData = cases[name];
      if (!caseData) {
        alert('Izbrani primer ni veƒç na voljo.');
        updateCasesSelect();
        return;
      }

      for (let r = 0; r < 12; r++) {
        for (let c = 0; c < 12; c++) {
          const cell = cells[r][c];
          if (cell && !cell.classList.contains('blank')) {
            cell.textContent = caseData.state[r][c];
            cell.classList.remove('error');
            cellWarnings.set(cell, 0);
          }
        }
      }

      document.getElementById('whoInput').value = caseData.inputs.who || '';
      document.getElementById('whereInput').value = caseData.inputs.where || '';
      document.getElementById('weaponInput').value = caseData.inputs.weapon || '';
      document.getElementById('whyInput').value = caseData.inputs.why || '';

      document.getElementById('caseNameInput').value = name;

      showToast(`üìÇ Primer "${name}" nalo≈æen`);
    }

    function deleteCase() {
      const select = document.getElementById('casesSelect');
      const name = select.value;
      if (!name) {
        alert('Prosim izberi primer za brisanje!');
        return;
      }

      if (!confirm(`Ali res ≈æeli≈° izbrisati primer "${name}"?`)) return;

      let cases = JSON.parse(localStorage.getItem('detectiveCases') || '{}');
      if (cases.hasOwnProperty(name)) {
        delete cases[name];
        localStorage.setItem('detectiveCases', JSON.stringify(cases));
        showToast(`üóëÔ∏è Primer "${name}" izbrisan`);
        updateCasesSelect();

        // ƒåe je bil izbrani primer nalo≈æen, ga poƒçistimo
        if (document.getElementById('caseNameInput').value === name) {
          resetGrid();
          clearInputs();
          document.getElementById('caseNameInput').value = "";
        }

        select.selectedIndex = 0;
      } else {
        alert('Izbrani primer ni najden.');
      }
    }

    function newCase() {
      if (!confirm("Ali ≈æeli≈° zaƒçeti nov primer? Vse neshranjene spremembe bodo izgubljene.")) return;
      resetGrid();
      clearInputs();
      document.getElementById('caseNameInput').value = "";
      const select = document.getElementById('casesSelect');
      select.selectedIndex = 0;
    }

    function clearInputs() {
      document.getElementById('whoInput').value = "";
      document.getElementById('whereInput').value = "";
      document.getElementById('weaponInput').value = "";
      document.getElementById('whyInput').value = "";
      saveInputs();
    }

    function updateCasesSelect() {
      const select = document.getElementById('casesSelect');
      const cases = JSON.parse(localStorage.getItem('detectiveCases') || '{}');

      const current = select.value;

      select.innerHTML = '<option value="" disabled selected>Izberi primer</option>';

      Object.keys(cases).forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });

      if (current && cases[current]) {
        select.value = current;
      }
    }

    // Ob zagonu nalo≈æi seznam primerov
    updateCasesSelect();

    // Nalo≈æi stanje mre≈æe in vnosov ob zagonu
    loadState();
    loadInputs();
    attachInputListeners();
    
    function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 2500);
}
  </script>
  <div id="toast" class="toast"></div>
</body>
</html>
